#!/usr/bin/env python3
"""
Script de configuration Netlify pour ProjectBot
Configure automatiquement les variables d'environnement
"""

import subprocess
import sys
from pathlib import Path

def run_command(cmd):
    """Ex√©cute une commande shell"""
    try:
        result = subprocess.run(cmd, shell=True, capture_output=True, text=True)
        return result.returncode == 0, result.stdout, result.stderr
    except Exception as e:
        return False, "", str(e)

def check_netlify_logged_in():
    """V√©rifie si l'utilisateur est connect√© √† Netlify"""
    success, stdout, stderr = run_command("netlify status")
    return success and "Not logged in" not in stdout

def set_env_variable(name, value):
    """D√©finit une variable d'environnement sur Netlify"""
    success, stdout, stderr = run_command(f'netlify env:set {name} "{value}"')
    return success

def get_env_variables():
    """R√©cup√®re les variables d'environnement"""
    success, stdout, stderr = run_command("netlify env:list")
    return stdout if success else ""

def main():
    print("üöÄ Configuration Netlify pour ProjectBot")
    print("=" * 50)
    print()

    # V√©rifier la connexion
    print("V√©rification de la connexion Netlify...")
    if not check_netlify_logged_in():
        print("‚ùå Vous ne √™tes pas connect√© √† Netlify")
        print()
        print("Veuillez d'abord ex√©cuter: netlify login")
        print()
        print("Ou avec un token:")
        print('  export NETLIFY_AUTH_TOKEN="votre-token-ici"')
        print('  netlify link')
        sys.exit(1)

    print("‚úÖ Vous √™tes connect√© √† Netlify")
    print()

    # Variables obligatoires
    print("üìù Configuration des variables d'environnement")
    print("=" * 50)
    print()
    print("Variables OBLIGATOIRES:")
    print()

    env_vars = {
        "GITHUB_TOKEN": "Token d'acc√®s GitHub avec permission 'repo'",
        "GITHUB_REPO_OWNER": "Propri√©taire du repo (ex: ProjectView)",
        "GITHUB_REPO_NAME": "Nom du repo (ex: site-projectview)",
    }

    optional_vars = {
        "GOOGLE_SHEETS_API_KEY": "Google Sheets API Key (optionnel)",
        "GOOGLE_SHEETS_SPREADSHEET_ID": "Google Sheets Spreadsheet ID (optionnel)",
        "TELEGRAM_BOT_TOKEN": "Telegram Bot Token (optionnel)",
        "TELEGRAM_CHAT_ID": "Telegram Chat ID (optionnel)",
    }

    # D√©finir les variables obligatoires
    for var_name, description in env_vars.items():
        value = input(f"üìå {description}\n   {var_name}: ").strip()
        if value:
            if set_env_variable(var_name, value):
                print(f"   ‚úÖ {var_name} d√©fini")
            else:
                print(f"   ‚ùå Erreur en d√©finissant {var_name}")
        else:
            print(f"   ‚ö†Ô∏è  {var_name} non fourni (OBLIGATOIRE!)")
        print()

    # D√©finir les variables optionnelles
    print("Variables OPTIONNELLES:")
    print()
    for var_name, description in optional_vars.items():
        value = input(f"üìå {description}\n   {var_name} (appuyez sur Entr√©e pour ignorer): ").strip()
        if value:
            if set_env_variable(var_name, value):
                print(f"   ‚úÖ {var_name} d√©fini")
            else:
                print(f"   ‚ùå Erreur en d√©finissant {var_name}")
        else:
            print(f"   ‚è≠Ô∏è  {var_name} ignor√©")
        print()

    # Afficher les variables d√©finies
    print()
    print("=" * 50)
    print("‚úÖ Variables d'environnement d√©finies:")
    print("=" * 50)
    print()
    vars_output = get_env_variables()
    print(vars_output)

    print()
    print("üéâ Configuration termin√©e!")
    print()
    print("Tu peux maintenant:")
    print("  1. Importer le workflow N8N")
    print("  2. Lancer Projectbot via Telegram")
    print("  3. G√©n√©rer des articles automatiquement ‚ú®")

if __name__ == "__main__":
    main()
